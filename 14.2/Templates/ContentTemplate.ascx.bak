<%@ Control Language="C#" CodeBehind="ContentTemplate.ascx.cs" ClassName="ContentTemplate" Inherits="SofIA_XAF_Bootstrap.Templates.ContentTemplate" %>
<%@ Register Assembly="SofIA XAF Bootstrap" Namespace="SofIA_XAF_Bootstrap.Controls" TagPrefix="cc1" %>
<%@ Register Assembly="DevExpress.Web.v14.2, Version=14.2.4.0, Culture=neutral, PublicKeyToken=b88d1754d700e49a" Namespace="DevExpress.Web" TagPrefix="dx" %>
<%@ Register Assembly="DevExpress.Web.v14.2" Namespace="DevExpress.Web"
    TagPrefix="dxrp" %>
<%@ Register Assembly="DevExpress.Web.v14.2" Namespace="DevExpress.Web"
    TagPrefix="dxge" %>
<%@ Register Assembly="DevExpress.Web.v14.2" Namespace="DevExpress.Web"
    TagPrefix="cb1" %>
<%@ Register Assembly="DevExpress.Web.v14.2" Namespace="DevExpress.Web"
    TagPrefix="cp1" %>
<%@ Register Assembly="DevExpress.ExpressApp.Web.v14.2" Namespace="DevExpress.ExpressApp.Web.Templates.ActionContainers"
    TagPrefix="cc2" %>
<%@ Register Assembly="DevExpress.ExpressApp.Web.v14.2" Namespace="DevExpress.ExpressApp.Web.Templates"
    TagPrefix="cc3" %>
<%@ Register Assembly="DevExpress.ExpressApp.Web.v14.2" Namespace="DevExpress.ExpressApp.Web.Controls"
    TagPrefix="cc4" %>
<%@ Register Assembly="DevExpress.ExpressApp.Web.v14.2" Namespace="DevExpress.ExpressApp.Web.Templates.Controls"
    TagPrefix="tc" %>

<div>
    <dx:ASPxGlobalEvents ID="GE" ClientInstanceName="GE" ClientSideEvents-EndCallback=""
        runat="server" />
    <!--
    <script id="dxis_748224825" src="/DXR.axd?r=1_171,1_94,1_164,1_93,1_146,1_134,1_91,1_156,1_162,1_147,1_114,1_121,1_105,1_149,1_104,6_12,1_154,1_92,1_153-UZ9i9" type="text/javascript"></script>
    -->

    <div class="jumbotron">
        <div class="container well content" id="content">            
            <div class="view-header row">
                <span class="col-md-6" id="leftColumnActions">
                    <!-- HEADER -->
                    <cc3:XafUpdatePanel ID="UPVH" runat="server">
                        <span class="h4 pull-left">
                            <span class="pull-left view-header-image">
                                <!-- Image -->
                                <cc4:ViewImageControl ID="VIC" runat="server" />
                            </span>
                            <span class="pull-left view-header-text">
                                <!-- Caption -->
                                <cc4:ViewCaptionControl ID="VCC" runat="server" />                                
                            </span>
                        </span>
                        <span style="display: none">
                            <!-- ViewRecordActions -->
                            <cc3:XafUpdatePanel ID="VRUP" runat="server" EnableTheming="False" UpdateAlways="True">
                                <cc2:ActionContainerHolder runat="server" ID="VRAH" ContainerStyle="Buttons"
                                    Orientation="Horizontal" Categories="ObjectsCreation;Edit;RecordEdit;View;Unspecified;" EnableViewState="False">
                                    <menu width="100%" itemautowidth="False" clientinstancename="mainMenu">
                                        <bordertop borderstyle="None" />
                                        <borderbottom borderstyle="None" />
                                        <borderleft borderstyle="None" />
                                        <borderright borderstyle="None" />
                                    </menu>
                                </cc2:ActionContainerHolder>
                            </cc3:XafUpdatePanel>
                        </span>     
                        <span class="pull-left view-record-actions">
                            <dx:ASPxLabel runat="server" Text="" ID="ViewRecordActions"></dx:ASPxLabel>
                        </span>

                        <span>
                            <!-- Navigation to rows buttons -->
                            <div style="display: none">
                                <cc2:ActionContainerHolder runat="server" ID="RNC" ContainerStyle="Links" Orientation="Horizontal"
                                    Categories="RecordsNavigation" UseLargeImage="True" PaintStyle="Image">
                                    <menu width="100%" itemautowidth="False" horizontalalign="Right" />
                                </cc2:ActionContainerHolder>
                            </div>

                        </span>

                    </cc3:XafUpdatePanel>
                </span>

                <span class="col-md-6" id="rightColumnActions">
                    <!-- Security -->
                    <span class="pull-right" style="display: none">
                        <cc3:XafUpdatePanel ID="UPSAC" runat="server">
                            <span style="display: none">
                                <cc2:ActionContainerHolder runat="server" ID="SAC" CssClass="Security" Categories="Security"
                                    ContainerStyle="Links" ShowSeparators="True" />
                            </span>
                            <dx:ASPxLabel runat="server" Text="" ID="SecurityActions"></dx:ASPxLabel>
                        </cc3:XafUpdatePanel>
                    </span>

                    <!-- Search and others -->
                    <span class="pull-right">
                        <cc3:XafUpdatePanel ID="UPSHC" runat="server">
                            <span style="display:none">
                                <cc2:ActionContainerHolder ID="SHC" runat="server" Categories="RootObjectsCreation;Search;FullTextSearch;"
                                    ContainerStyle="Links" CssClass="TabsContainer" />                                
                            </span>
                            <dx:ASPxLabel ID="SearchActions" runat="server" Text="ASPxLabel"></dx:ASPxLabel>
                        </cc3:XafUpdatePanel>                        
                    </span>

                    <div>
                        <!-- Object Actions -->

                        <span class="pull-right">
                            <cc3:XafUpdatePanel ID="UPTB" runat="server" EnableTheming="False" UpdateAlways="True">
                                <span style="display: none">
                                    <cc2:ActionContainerHolder runat="server" ID="TB" ContainerStyle="Buttons"
                                        Orientation="Horizontal" Categories="Export;Reports;Filters;" EnableViewState="False">
                                        <menu width="100%" itemautowidth="False" clientinstancename="mainMenu">
                                            <bordertop borderstyle="None" />
                                            <borderbottom borderstyle="None" />
                                            <borderleft borderstyle="None" />
                                            <borderright borderstyle="None" />
                                        </menu>
                                    </cc2:ActionContainerHolder>
                                </span>
                                <dx:ASPxLabel runat="server" Text="" ID="Actions"></dx:ASPxLabel>
                            </cc3:XafUpdatePanel>
                        </span>
                    </div>
                </span>
            </div>            


            <!-- ACTIONS -->
            <div class="container-actions">
                <span>
                    <span class="pull-right">
                        <!-- Top Actions -->
                        <cc3:XafUpdatePanel ID="UPEMA" runat="server">
                            <span style="display: none">
                                <cc2:ActionContainerHolder runat="server" ID="EMA" ContainerStyle="Links" Orientation="Horizontal"
                                    Categories="Save;UndoRedo" CssClass="EditModeActions">
                                    <menu width="100%" itemautowidth="False" horizontalalign="Right" />
                                </cc2:ActionContainerHolder>
                            </span>
                            <dx:ASPxLabel runat="server" ID="TopActions"></dx:ASPxLabel>
                        </cc3:XafUpdatePanel>
                    </span>
                    <span class="">
                        <!-- View -->
                        <cc3:XafUpdatePanel ID="UPEI" runat="server">
                            <tc:ErrorInfoControl ID="ErrorInfo" Style="margin: 10px 0px 10px 0px" runat="server" />
                        </cc3:XafUpdatePanel>
                        <br />
                        <cc3:XafUpdatePanel ID="UPVSC" runat="server">
                            <!-- View -->
                            <cc4:ViewSiteControl ID="VSC" runat="server" />

                            <!-- Bottom Actions -->
                            <span style="display: none">
                                <cc2:ActionContainerHolder runat="server" ID="EditModeActions2" ContainerStyle="Links"
                                    Orientation="Horizontal" Categories="Save;UndoRedo" CssClass="EditModeActions">
                                    <menu width="100%" itemautowidth="False" horizontalalign="Right" paddings-paddingtop="15px" />
                                </cc2:ActionContainerHolder>
                            </span>
                            <span class="pull-right">
                                <dx:ASPxLabel runat="server" ID="BottomActions"></dx:ASPxLabel>
                            </span>
                        </cc3:XafUpdatePanel>

                    </span>
                    <span>
                        <cc3:XafUpdatePanel ID="UPQC" runat="server">
                            <cc2:QuickAccessNavigationActionContainer CssClass="NavigationLinks" ID="QC" runat="server"
                                ContainerId="ViewsNavigation" PaintStyle="Caption" ShowSeparators="True" />
                        </cc3:XafUpdatePanel>
                    </span>
                </span>

            </div>
        </div>
    </div>

    <div>
        <cc3:XafUpdatePanel ID="UPIMP" runat="server">
            <asp:Literal ID="InfoMessagesPanel" runat="server" Text="" Visible="False"></asp:Literal>
            
            <!-- Fixed navbar -->
            <dx:ASPxLabel runat="server" ID="TopMenu" EncodeHtml="false"></dx:ASPxLabel>
        </cc3:XafUpdatePanel>
    </div>    
</div>



<div class="container">
    <span class="pull-right"><a href="#">Техническая поддержка</a></span>
    <hr />
    <table cellpadding="0" cellspacing="0" border="0" width="100%">
        <tr>
            <td align="left">
                <div class="FooterCopyright">
                    <cc4:AboutInfoControl ID="AIC" runat="server">Copyright text</cc4:AboutInfoControl>
                </div>
            </td>
        </tr>
    </table>
    <br />
    <br />
</div>

<cc1:XafBootstrapCallback runat="server" ID="PopupCallback" ClientInstanceName="PopupCallback" EnableViewState="False" OnCallback="PopupCallback_Callback"></cc1:XafBootstrapCallback>

<div id="LPcell" style="display: none" />
<div id="separatorCell" style="display: none" />
<div id="separatorImage" style="display: none" />
<div id="MT" style="display: none" />
<div id="MRC" style="display: none" />

<script type="text/javascript">
    function ShowXafMessage(caption, confirmationMessage, callback) {
        var modal = $(
            '<div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">' +
                '<div class="modal-header">' +
                    '<button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;' +
                    '<span aria-hidden="true"></span>' +
                '</button>' +
                '<h4 class="modal-title"></h4>' +
            '</div>' +
            '<div class="modal-body">' +
                '<p></p>' +
            '</div>' +
            '<div class="modal-footer">' +
                '<button type="button" class="btn btn-primary" data-dismiss="modal" id="XafBootstrapConfirmButton">Подтвердить</button>' +
                '<button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>' +
            '</div>' +
            '</div>'
            );
        modal.find('h4.modal-title').text(caption);
        modal.find('div.modal-body').text(confirmationMessage);
        modal.find('#XafBootstrapConfirmButton').on('click', callback);
        modal.modal();
    }
</script>

<script>
    $(document).ready(function () {
        $("#content").css('margin-top', $('#navbar').height());
        $(window).resize(function () {
            if ($(window).width() < 744)
                $("#content").css('margin-top', $('#navbar').height() - 40);
            else
                $("#content").css('margin-top', $('#navbar').height());
        });

        window.openXafPopupWindowCached = window.openXafPopupWindow;
        window.openXafPopupWindow = function (popupWindowCallbackPanelId, targetControlId, url, isSizeable, forcePostBack, callBackFuncName) {
            window.createXafBootstrapPopup(popupWindowCallbackPanelId, targetControlId, url, isSizeable, forcePostBack, callBackFuncName);
        }

        window.createXafBootstrapPopup = function (popupWindowCallbackPanelId, targetControlId, url, isSizeable, forcePostBack, callBackFuncName, sender) {
            if (!(sender))
                sender = window;

            var modal = $("<div class='modal container fade'>"
                    + "<div class='loader' style='position: absolute; left: 50%; top: 50%;'>"
                        + "<div style='position: relative; left: -50%; top: -50%;'>"
                            + "<img src='images/ajax-loader.gif'>"
                        + "</div>"
                    + "</div>"
                + "</div>")
            var iframe = $("<iframe scrolling='no' frameborder='0' src='" + url + "' style='width: 100%; height: 254px; overflow: auto; vertical-align: text-bottom;'></iframe>");

            iframe.on("load", function () {
                var iframeDoc = iframe[0].contentWindow;
                modal.find('.loader').each(function () {
                    $(this).hide();
                });

                iframeDoc.createXafBootstrapPopup = window.createXafBootstrapPopup;
                iframeDoc.ShowXafMessage = window.ShowXafMessage;
                iframeDoc.RaiseXafCallback = function (callbackControl, handlerId, parameters, confirmation, usePostBack) {
                    window.RaiseXafCallback(callbackControl, handlerId, parameters, confirmation, usePostBack, iframeDoc);
                };

                iframeDoc.startProgress = function () {
                    if (!iframeDoc.isCancelProgress) {
                        iframeDoc.ProgressControlTimer = iframeDoc.setTimeout("xafProgressControl.Show();", 500);
                        iframeDoc.document.onstop = stopProgress;
                        iframeDoc.onblur = stopProgress;
                        iframeDoc.setTimeout(function () {
                            if (iframeDoc.stopProgress)
                                iframeDoc.stopProgress();
                        }, 4000);
                    }
                    isCancelProgress = false;
                };

                iframeDoc.stopProgress = function () {
                    iframeDoc.clearTimeout(iframeDoc.ProgressControlTimer);
                    if (iframeDoc.xafProgressControl && iframeDoc.xafProgressControl.shown) {
                        iframeDoc.xafProgressControl.Hide();
                        iframeDoc.xafProgressControl.started = false;
                    }
                    iframeDoc.document.body.onscroll = null;
                    iframeDoc.document.body.onresize = null;
                };

                iframeDoc.closeThisModal = function () {
                    modal.modal('hide');
                };
                iframeDoc.isChildFrame = true;
                if (sender.isChildFrame) {
                    iframeDoc.parentFrameWindow = sender;
                }
                iframeDoc.calculateWindowSize = function () {
                    var frameWindow = iframe[0].contentWindow;                    
                    if (frameWindow != null) {
                        var newHeight = frameWindow.document.body.offsetHeight;
                        if (iframe.height() != newHeight) {
                            iframe.height(newHeight + "px");
                            $(window).trigger('resize.modal');
                        }
                        newHeight = iframe.height();
                    }
                }

                var calcFunc = function () { setTimeout(iframeDoc.calculateWindowSize, 250); };
                iframeDoc.globalCallbackControl.EndCallback.AddHandler(calcFunc);
                $(iframeDoc).click(function () {
                    calcFunc();
                });
                modal.on('hide.bs.modal', function (e) {
                    if (iframeDoc.DataChanged) {
                        e.preventDefault();
                        checkDataChanged(iframeDoc, function () { iframeDoc.closeThisModal(); });
                    }
                });
                calcFunc();
                modal.on('hidden.bs.modal', function (e) {
                    if (sender.isChildFrame) {
                        globalCallbackControl.EndCallback.RemoveHandler(calcFunc);
                    }
                    sender.RaiseXafCallback(sender.globalCallbackControl, "", "XafParentWindowRefresh", "", false);
                });
            });
            modal.append(iframe);
            modal.modal();
        };

        window.startProgress = function () {
            if (!isCancelProgress) {
                window.ProgressControlTimer = window.setTimeout("xafProgressControl.Show();", 500);
                document.onstop = stopProgress;
                window.onblur = stopProgress;
                setTimeout(function () {
                    if (window.stopProgress)
                        window.stopProgress();
                }, 4000);
            }
            isCancelProgress = false;
        };
        window.stopProgress = function () {
            window.clearTimeout(window.ProgressControlTimer);
            if (xafProgressControl && xafProgressControl.shown) {
                xafProgressControl.Hide();
                xafProgressControl.started = false;
            }
            document.body.onscroll = null;
            document.body.onresize = null;
        };

        window.RaiseXafCallbackCached = window.RaiseXafCallback;
        window.RaiseXafCallback = function RaiseXafCallback(callbackControl, handlerId, parameters, confirmation, usePostBack, sender) {
            if (!(sender))
                sender = window;
            var isRaised = false;
            var raiseFunc = function () {
                var parameter = handlerId + ':' + parameters;
                if (usePostBack) {
                    callbackControl.SendPostBack(parameter);
                } else {
                    sender.startProgress();
                    callbackControl.PerformCallback(parameter);
                }
                isRaised = true;
            };

            if (confirmation != "") {
                sender.ShowXafMessage("Подтвердите действие", confirmation, raiseFunc);
            } else {
                raiseFunc();
            };

            return isRaised;
        }
    });
</script>

<script>
    $(document).ready(function () {
         window.onbeforeunload = function (e) { if (window.DataChanged) return 'На странице присутствуют неподтвержденные изменения'; };
         if (window.CachedRaiseXafCallback == null) {
            {
                window.CachedRaiseXafCallback = RaiseXafCallback;
                window.DataChanged = false;
                RaiseXafCallback = function (callbackControl, handlerId, parameters, confirmation, usePostBack, sender) {
                    if (!(sender))
                        sender = window;
                    sender.DataChangedFunctionWithoutCommit = function () {
                        sender.DataChanged = false;
                        window.CachedRaiseXafCallback(callbackControl, handlerId, parameters, confirmation, usePostBack, sender);
                    }
                    if (handlerId == 'MenuItemClickControllerCallback' || parameters == 'Action=Refresh')
                        checkDataChanged(sender, sender.DataChangedFunctionWithoutCommit);
                    else
                    {
                        sender.DataChangedFunctionWithoutCommit();
                    }
                }
            }
        }
    });

    function checkDataChanged(sender, callback) {
        if (sender.DataChanged == true)
        {
            var dialog =
           $('<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">'
                + '<div class="modal-header">Подтверждение'
                + '</div>'
                + '<div class="modal-body">Изменения не сохранены. Продолжить?'
                + '</div>'
                + '<div class="modal-footer">'
                    + '<button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>'
                    + '<button id="DoWithoutCommitButton"type="button" class="btn btn-danger danger" data-dismiss="modal">Без сохранения</button>'
                + '</div>'
            + '</div>');
            dialog.modal({ show: true });
            if (callback)
            {
                dialog.find("#DoWithoutCommitButton").click(function () {sender.DataChanged = false; callback(); });
            }
        }
        else
        {
            sender.DataChanged = false;
            callback();
        }
    }
</script>

